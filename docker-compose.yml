services:
  kdv-api:
    build: .
    container_name: kdv-api
    restart: unless-stopped
    
    # üü¢ 1. –ó–∞–ø—É—Å–∫ Production —Å–µ—Ä–≤–µ—Ä–∞ (Gunicorn) –Ω–∞ –ø–æ—Ä—Ç—É 5000
    command: gunicorn -w 4 -b 0.0.0.0:5000 src.app:app
    
    env_file:
      - .env
      
    environment:
      - TZ=Europe/Kyiv
      # –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —è–≤–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ —à–ª—è—Ö –¥–æ –¥–∏—Å–∫—É, —Ö–æ—á–∞ –≤—ñ–Ω —î –≤ .env
      - INTEGRATOR_MOUNT_PATH=/mnt/drive 

    volumes:
      - .:/app                 # –ú–æ–Ω—Ç—É—î–º–æ –∫–æ–¥, —â–æ–± –∑–º—ñ–Ω–∏ –ø—ñ–¥—Ç—è–≥—É–≤–∞–ª–∏—Å—å –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
      # üü¢ 2. –û–±–æ–≤'—è–∑–∫–æ–≤–æ –º–æ–Ω—Ç—É—î–º–æ –¥–∏—Å–∫ (rclone), —ñ–Ω–∞–∫—à–µ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–Ω–∞–π–¥–µ PDF —Ñ–∞–π–ª–∏
      - /mnt/drive:/mnt/drive 
      
    networks:
      - dspacenet

    labels:
      - "traefik.enable=true"
      # –•–æ—Å—Ç –∑–∞–ª–∏—à–∏–≤ —Ç–≤—ñ–π
      - "traefik.http.routers.kdv-api.rule=Host(`${HOST}`) && PathPrefix(`/kdv/api`)"
      - "traefik.http.routers.kdv-api.priority=100"
      - "traefik.http.routers.kdv-api.entrypoints=web"
      
      # üü¢ 3. –ü–æ—Ä—Ç –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ 5000 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç Flask/Gunicorn)
      - "traefik.http.services.kdv-api.loadbalancer.server.port=5000"
      
      - "traefik.docker.network=dspacenet"
      
      # üî¥ 4. StripPrefix –ó–ê–ö–û–ú–ï–ù–¢–û–í–ê–ù–û (–í–∏–¥–∞–ª–µ–Ω–æ)
      # –ß–æ–º—É: –ù–∞—à Flask app (src/app.py) –≤–∂–µ –æ—á—ñ–∫—É—î –ø–æ–≤–Ω–∏–π —à–ª—è—Ö '/kdv/api/...'
      # –Ø–∫—â–æ Traefik –≤—ñ–¥—Ä—ñ–∂–µ –ø—Ä–µ—Ñ—ñ–∫—Å, Flask –ø–æ–≤–µ—Ä–Ω–µ 404.
      # - "traefik.http.middlewares.kdv-api-strip.stripprefix.prefixes=/kdv/api"
      # - "traefik.http.routers.kdv-api.middlewares=kdv-api-strip"
      
      # –û—Å–∫—ñ–ª—å–∫–∏ –º—ñ–¥–ª–≤–∞—Ä–∏ –Ω–µ–º–∞—î, —Ü–µ–π —Ä—è–¥–æ–∫ —Ç–µ–∂ –∫–æ–º–µ–Ω—Ç—É—î–º–æ:
      # - "traefik.http.routers.kdv-api.middlewares=kdv-api-strip"

networks:
  dspacenet:
    external: true